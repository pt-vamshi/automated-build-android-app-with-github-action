name: Generated APK AAB (Upload - Create Artifact To Github Action)

env:
  # The name of the main module repository
  main_project_module: app

  # The name of the Play Store
  playstore_name: Frogobox ID

on:

  push:
    branches:
      - 'release/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Set Current Date As Env Variable
      - name: Set current date as env variable
        run: echo "date_today=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      # Set Repository Name As Env Variable
      - name: Set repository name as env variable
        run: echo "repository_name=$(echo '${{ github.repository }}' | awk -F '/' '{print $2}')" >> $GITHUB_ENV

      - name: Set Up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu' # See 'Supported distributions' for available options
          java-version: '17'
          cache: 'gradle'

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      # Run Tests Build
      - name: Run gradle tests
        run: ./gradlew test

      # Run Build Project
      - name: Build gradle project
        run: ./gradlew build

      # Create APK Debug
      - name: Build apk debug project (APK) - ${{ env.main_project_module }} module
        run: ./gradlew assembleDebug

      # Create APK Release
      - name: Build apk release project (APK) - ${{ env.main_project_module }} module
        run: ./gradlew assemble

      # Create Bundle AAB Release
      # Noted for main module build [main_project_module]:bundleRelease
      - name: Build app bundle release (AAB) - ${{ env.main_project_module }} module
        run: ./gradlew ${{ env.main_project_module }}:bundleRelease

      # Upload Artifact Build
      # Noted For Output [main_project_module]/build/outputs/apk/debug/
      - name: Upload APK Debug - ${{ env.repository_name }}
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.date_today }} - ${{ env.playstore_name }} - ${{ env.repository_name }} - APK(s) debug generated
          path: ${{ env.main_project_module }}/build/outputs/apk/debug/

      # Noted For Output [main_project_module]/build/outputs/apk/release/
      - name: Upload APK Release - ${{ env.repository_name }}
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.date_today }} - ${{ env.playstore_name }} - ${{ env.repository_name }} - APK(s) release generated
          path: ${{ env.main_project_module }}/build/outputs/apk/release/

      # Noted For Output [main_project_module]/build/outputs/bundle/release/
      - name: Upload AAB (App Bundle) Release - ${{ env.repository_name }}
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.date_today }} - ${{ env.playstore_name }} - ${{ env.repository_name }} - App bundle(s) AAB release generated
          path: ${{ env.main_project_module }}/build/outputs/bundle/release/
      - name: Get sample .apk for test purposes
        run: sudo curl -O https://github.com/pt-vamshi/automated-build-android-app-with-github-action/suites/13886515128/artifacts/772140570 -O temp.zip. && unzip temp.zip
      - name: Upload artifact to Firebase Distribution
        uses: ./
        with:
          appId: ${{secrets.FIREBASE_APP_ID}}
          token: ${{secrets.FIREBASE_TOKEN}}
          groups: Testers
          file: github-action-automated-release.apk
      - name: Upload artifact to Firebase Distribution with release note file
        uses: ./
        with:
          appId: ${{secrets.FIREBASE_APP_ID}}
          token: ${{secrets.FIREBASE_TOKEN}}
          groups: Testers
          releaseNotesFile: README.md
          file: ApiDemos-debug.apk
      - name: Upload artifact to Firebase Distribution with debug
        uses: ./
        with:
          appId: ${{secrets.FIREBASE_APP_ID}}
          token: ${{secrets.FIREBASE_TOKEN}}
          groups: Testers
          releaseNotesFile: README.md
          file: github-action-automated-release.apk
          debug: true
      # - name: Fetch credential file from secrets
      #   id: fetch_credential_file
      #   uses: timheuer/base64-to-file@v1
      #   with:
      #     encodedString: ${{ secrets.CREDENTIAL_FILE }}
      #     fileName: 'credential_file.json'
      # - name: Move credential file to repository location
      #   run: mv ${{ steps.fetch_credential_file.outputs.filePath }} /home/runner/work/React-Native-Expo-News-App/React-Native-Expo-News-App/
      # - name: Upload artifact to Firebase Distribution using credential file
      #   uses: ./
      #   with:
      #     appId: ${{secrets.FIREBASE_APP_ID}}
      #     groups: Testers
      #     releaseNotesFile: README.md
      #     file: ApiDemos-debug.apk
      #     debug: true
      #     serviceCredentialsFile: credential_file.json
      # - name: Upload artifact to Firebase Distribution using credential file content
      #   uses: ./
      #   with:
      #     appId: ${{secrets.FIREBASE_APP_ID}}
      #     groups: Testers
      #     releaseNotesFile: README.md
      #     file: ApiDemos-debug.apk
      #     debug: true
      #     serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
      - name: Upload artifact to Firebase Distribution with testers
        uses: ./
        with:
          appId: ${{secrets.FIREBASE_APP_ID}}
          token: ${{secrets.FIREBASE_TOKEN}}
          testers: "vamshi@pearlthoughts.com"
          releaseNotesFile: README.md
          file: github-action-automated-release.apk
      - name: Failure during upload should set failure in action step
        id: fail_check
        uses: ./
        continue-on-error: true
        with:
          appId: invalid_app_id
          token: ${{secrets.FIREBASE_TOKEN}}
          testers: "vamshi@pearlthoughts.com"
          releaseNotesFile: README.md
          file: github-action-automated-release.apk
      - name: Check if previous step failed as expected
        run: |
          if [[ "${{ steps.fail_check.outcome }}" == 'failure' ]]; then
            echo "Previous step failed as expected"
            exit 0
          else
            echo "Previous step succeeded, when it shouldn't"
            exit 1
          fi
          
          
     
